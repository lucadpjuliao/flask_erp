{% extends "base.html" %}

{% block title %}An√°lises de Leads - CRM Profissional{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">üìä An√°lises de Leads</h1>
    <div class="btn-group">
        <button class="btn btn-outline-primary" onclick="loadAnalytics(30)">30 dias</button>
        <button class="btn btn-outline-primary" onclick="loadAnalytics(90)">90 dias</button>
        <button class="btn btn-outline-primary" onclick="loadAnalytics(365)">1 ano</button>
    </div>
</div>

<!-- Cards de M√©tricas -->
<div class="row mb-4" id="metricsCards">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stats-card">
            <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                    <div class="stats-number" id="totalLeads">-</div>
                    <div>Total de Leads</div>
                </div>
                <div class="flex-shrink-0">
                    <i class="fas fa-bullseye fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stats-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
            <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                    <div class="stats-number" id="conversionRate">-</div>
                    <div>Taxa de Convers√£o</div>
                </div>
                <div class="flex-shrink-0">
                    <i class="fas fa-percentage fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stats-card" style="background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);">
            <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                    <div class="stats-number" id="avgConversionDays">-</div>
                    <div>Dias M√©dios p/ Convers√£o</div>
                </div>
                <div class="flex-shrink-0">
                    <i class="fas fa-clock fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stats-card" style="background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);">
            <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                    <div class="stats-number" id="totalValue">-</div>
                    <div>Valor Total</div>
                </div>
                <div class="flex-shrink-0">
                    <i class="fas fa-dollar-sign fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Gr√°fico de Status -->
    <div class="col-xl-6 col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold">Distribui√ß√£o por Status</h6>
            </div>
            <div class="card-body">
                <canvas id="statusChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Top Performers -->
    <div class="col-xl-6 col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold">üèÜ Top Performers</h6>
            </div>
            <div class="card-body">
                <div id="topPerformers">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p>Carregando dados...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Leads em Atraso -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-danger">‚ö†Ô∏è Leads em Atraso</h6>
                <button class="btn btn-sm btn-outline-danger" onclick="loadOverdueLeads()">
                    <i class="fas fa-refresh me-2"></i>Atualizar
                </button>
            </div>
            <div class="card-body">
                <div id="overdueLeads">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p>Carregando leads em atraso...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let statusChart;

// Carregar an√°lises
function loadAnalytics(days = 30) {
    fetch(`/api/leads/analytics?period=${days}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateMetrics(data.analytics);
                updateStatusChart(data.analytics.leads_by_status);
                updateTopPerformers(data.analytics.top_performers);
            }
        })
        .catch(error => console.error('Erro ao carregar analytics:', error));
}

// Atualizar m√©tricas
function updateMetrics(analytics) {
    document.getElementById('totalLeads').textContent = analytics.total_leads;
    document.getElementById('conversionRate').textContent = analytics.conversion_rate + '%';
    document.getElementById('avgConversionDays').textContent = analytics.avg_conversion_days;
    document.getElementById('totalValue').textContent = 'R$ ' + analytics.total_value.toLocaleString('pt-BR');
}

// Atualizar gr√°fico de status
function updateStatusChart(statusData) {
    const ctx = document.getElementById('statusChart').getContext('2d');
    
    if (statusChart) {
        statusChart.destroy();
    }
    
    const labels = Object.keys(statusData);
    const values = Object.values(statusData);
    const colors = {
        'novo': '#17a2b8',
        'qualificado': '#ffc107',
        'proposta': '#fd7e14',
        'negociacao': '#6f42c1',
        'fechado': '#28a745',
        'perdido': '#dc3545'
    };
    
    statusChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels.map(l => l.charAt(0).toUpperCase() + l.slice(1)),
            datasets: [{
                data: values,
                backgroundColor: labels.map(l => colors[l] || '#6c757d'),
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// Atualizar top performers
function updateTopPerformers(performers) {
    const container = document.getElementById('topPerformers');
    
    if (performers.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-user-times fa-3x mb-3"></i>
                <p>Nenhum fechamento no per√≠odo</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    performers.forEach((performer, index) => {
        const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üèÖ';
        html += `
            <div class="d-flex align-items-center mb-3 p-3 bg-light rounded">
                <div class="me-3">
                    <span class="fs-4">${medal}</span>
                </div>
                <div class="flex-grow-1">
                    <h6 class="mb-1">${performer.name}</h6>
                    <small class="text-muted">${performer.leads} leads fechados</small>
                </div>
                <div class="text-end">
                    <strong class="text-success">R$ ${performer.value.toLocaleString('pt-BR')}</strong>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Carregar leads em atraso
function loadOverdueLeads() {
    fetch('/api/leads/overdue')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateOverdueLeads(data.overdue_leads);
            }
        })
        .catch(error => console.error('Erro ao carregar leads em atraso:', error));
}

// Atualizar leads em atraso
function updateOverdueLeads(leads) {
    const container = document.getElementById('overdueLeads');
    
    if (leads.length === 0) {
        container.innerHTML = `
            <div class="text-center text-success py-4">
                <i class="fas fa-check-circle fa-3x mb-3"></i>
                <p>Nenhum lead em atraso! üéâ</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-hover">';
    html += `
        <thead>
            <tr>
                <th>Lead</th>
                <th>Status</th>
                <th>Valor</th>
                <th>Data Esperada</th>
                <th>Dias em Atraso</th>
                <th>Respons√°vel</th>
            </tr>
        </thead>
        <tbody>
    `;
    
    leads.forEach(lead => {
        const statusClass = `status-${lead.status}`;
        html += `
            <tr>
                <td>
                    <a href="/leads/${lead.id}" class="text-decoration-none">
                        ${lead.title}
                    </a>
                </td>
                <td><span class="badge ${statusClass}">${lead.status}</span></td>
                <td>R$ ${lead.value.toLocaleString('pt-BR')}</td>
                <td>${lead.expected_date}</td>
                <td><span class="badge bg-danger">${lead.days_overdue} dias</span></td>
                <td>${lead.assigned_user}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

// Carregar dados iniciais
document.addEventListener('DOMContentLoaded', function() {
    loadAnalytics(30);
    loadOverdueLeads();
});
</script>
{% endblock %}